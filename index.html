<!DOCTYPE html>
<html>
  <head>
    <title>Block Smasher!</title>
    <style>
   
      #begin {
        width:100vw;
        height:100vh;
        background-color:black;
        position:absolute;
        top:50%;
        left:50%;
        transform:translate(-50%, -50%);
        margin:0;
        font-size:1vw;
        z-index:1;
      }
      #usernameInput{
        position:absolute;
        top:50%;
        left:50%;
        transform:translate(-50%, -50%);
        margin:0;
        width:20em;
        height:4em;
        text-align:center;
        font-size:2.5em;
      }
      #usernameInput:focus{
        outline:none;
      }
      .player{
        width:50px;
        height:50px;
        background-color:black;
        text-align:center;
        font-weight:bold;
        position:absolute;
        color:white;
      }
      #canvas {
        position:absolute;
      }
    </style>
  </head>
  <body>
    
    <div id = "begin">
      <input id = "usernameInput" placeholder="Enter Your Username" maxLength="5">
    </div>
    <canvas id ="canvas"></canvas>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      var spawned = false;
      var started = false;
      var socket = io();
      var players = new Object({});
      var username;
      var canvas = document.getElementById('canvas');
      canvas.width = innerWidth;
      canvas.height = innerHeight;
      var ctx = canvas.getContext("2d");
      var gravity = 1;
      class Player{
        constructor({x,y,color}){
          this.position = {
            x:x,
            y:y,
          }
          this.velocity = {
            x:0,
            y:5,
          }
          this.midair = true;
          this.width = 50;
          this.height= 50;
          this.leftEdge = false;
          this.rightEdge = false;
          this.color = color;
        }
        create(){
          ctx.fillStyle = this.color;
          ctx.fillRect(this.position.x,this.position.y,this.width,this.height);
        }
        update(){
          
          if (this.position.y + this.height + this.velocity.y >= canvas.height+10){
            this.velocity.y = 0;
            this.midair = false;
          } else {
            this.velocity.y += gravity;
            this.midair = true;
          }
          if (this.position.x+this.velocity.x <= 3){
            this.leftEdge = true;
            this.velocity.x = 0;
          } else if (this.position.x+this.width+this.velocity.x>= canvas.width){
            this.rightEdge = true;
            this.velocity.x = 0;
          } else {
            this.rightEdge = false;
            this.leftEdge = false;
          }
        }
      }
      const movement = {
        right: false,
        left: false,
        up: false,
      }
      const movementArrow = {
        right: false,
        left: false,
        up: false,
      }
      function animate(){
        ctx.clearRect(0, 0, window.innerWidth, window.innerHeight);
        requestAnimationFrame(animate);
        if (spawned){
          if (movement.right && players[username].rightEdge == false){
          players[username].velocity.x = 5;
        } else if (movement.left && players[username].leftEdge == false){
          players[username].velocity.x = -5;
        } else {
          players[username].velocity.x = 0;
        }
        if (movement.up && players[username].midair == false){
          players[username].velocity.y -= 15;
        }
        players[username].position.x += players[username].velocity.x;
        players[username].position.y += players[username].velocity.y;
        socket.emit('move', username, players[username].position.x,players[username].position.y);
      
        }
      }
    
    
    window.addEventListener('keydown', event =>{
      if(event.key == "Enter" && !started){
    started=true;
    username = document.getElementById('usernameInput').value;
    document.body.removeChild(document.getElementById('begin'));
    socket.emit('spawn player', username);
    animate();
    
    }
        if (event.key == "d"){
            movement.right = true;
        } else if (event.key == "a"){
            movement.left = true;
        } else if (event.key == "w"){
            movement.up = true;
        }
        
    })
    window.addEventListener('keyup', event=>{
        if (event.key == "d"){
            movement.right = false;
        } else if (event.key == "a"){
            movement.left = false;
        } else if (event.key == "w"){
            movement.up = false;
        }

    })
    



socket.on('move', function(user, valX, valY){
  
  if (players[user] == undefined){
    spawnPlayerManual(user);
    
  }
  players[user].position.x = valX;
  players[user].position.y = valY;
  if (players[user].position.y + players[user].height + players[user].velocity.y >= canvas.height+10){
            players[user].velocity.y = 0;
            players[user].midair = false;
          } else {
            players[user].velocity.y += gravity;
            players[user].midair = true;
          }
          if (players[user].position.x+players[user].velocity.x <= 3){
            players[user].leftEdge = true;
            players[user].velocity.x = 0;
          } else if (players[user].position.x+players[user].width+players[user].velocity.x>= canvas.width){
            players[user].rightEdge = true;
            players[user].velocity.x = 0;
          } else {
            players[user].rightEdge = false;
            players[user].leftEdge = false;
          }
        ctx.fillStyle = players[user].color;
          ctx.fillRect(players[user].position.x,players[user].position.y,players[user].width,players[user].height);
  // console.log(players[user]);
        
        

});
socket.on('update', function(variable, amount){
  
  
});
socket.on('spawn player', function(user) {
  console.log("spawned");
    players[user] = new Player({x:100, y:400, color:"blue"});
    spawned = true;

});
function spawnPlayerManual(user) {
  console.log("created");
  players[user] = new Player({x:100, y:400, color:"blue"});
}


  </script>
  </body>
</html>
