<!DOCTYPE html>
<html>
  <head>
    <title>Block Smasher!</title>
    <style>
   
      #begin {
        width:100vw;
        height:100vh;
        background-color:black;
        position:absolute;
        top:50%;
        left:50%;
        transform:translate(-50%, -50%);
        margin:0;
        font-size:1vw;
        z-index:1;
      }
      #usernameInput{
        position:absolute;
        top:50%;
        left:50%;
        transform:translate(-50%, -50%);
        margin:0;
        width:20em;
        height:4em;
        text-align:center;
        font-size:2.5em;
      }
      #usernameInput:focus{
        outline:none;
      }
      .player{
        width:50px;
        height:50px;
        background-color:black;
        text-align:center;
        font-weight:bold;
        position:absolute;
        color:white;
      }
      #canvas {
        position:absolute;
      }
    </style>
  </head>
  <body>
    
    <div id = "begin">
      <input id = "usernameInput" placeholder="Enter Your Username" maxLength="5">
    </div>
    <canvas id ="canvas"></canvas>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      var spawned = false;
      var started = false;
      var socket = io();
      var players = new Object({});
      var username;
      var canvas = document.getElementById('canvas');
      canvas.width = innerWidth;
      canvas.height = innerHeight;
      var canvas = document.getElementById('canvas');
      var ctx = canvas.getContext("2d");
      var gravity = 1;
      var usernameList = [];
      var prevX;
      var prevY;
      class Player{
        constructor({x,y,color}){
          this.position = {
            x:x,
            y:y,
          }
          this.velocity = {
            x:0,
            y:0,
          }
          this.midair = true;
          this.width = 50;
          this.height= 50;
          this.leftEdge = false;
          this.rightEdge = false;
          this.color = color;
          this.disconnectTimer = 0;
          this.prevX = 0;
          this.prevY = 0;
        }
        create(){
          ctx.fillStyle = this.color;
          ctx.fillRect(this.position.x,this.position.y,this.width,this.height);
        }
        test(){
          alert("Created");
        }
        update(){

        }
      }
      const movement = {
        right: false,
        left: false,
        up: false,
      }
      const movementArrow = {
        right: false,
        left: false,
        up: false,
      }
      function animate(){
        ctx.clearRect(0, 0, window.innerWidth, window.innerHeight);
        requestAnimationFrame(animate);
        if (spawned){
          if (movement.right && players[username].rightEdge == false){
          players[username].velocity.x = 5;
        } else if (movement.left && players[username].leftEdge == false){
          players[username].velocity.x = -5;
        } else {
          players[username].velocity.x = 0;
        }
        
        players[username].position.x += players[username].velocity.x;
        players[username].position.y += players[username].velocity.y;
        socket.emit('move', username, players[username].position.x,players[username].position.y);
        for(let i = 0; i<usernameList.length; i++){
          if (players[usernameList[i]].prevX == players[usernameList[i]].position.x && players[usernameList[i]].prevY == players[usernameList[i]].position.y){
            players[usernameList[i]].disconnectTimer +=1;
          } else {
            players[usernameList[i]].disconnectTimer = 0;
          }
          
          
          if (players[usernameList[i]].disconnectTimer == 3000){
              alert("WARNING! You are going to be disconnected for being AFK.");
          } else if (players[usernameList[i]].disconnectTimer == 3600){
              usernameList.splice(usernameList.indexOf(usernameList[i]), 1);


          }
          players[usernameList[i]].create();
          players[usernameList[i]].prevX = players[usernameList[i]].position.x;
          players[usernameList[i]].prevY = players[usernameList[i]].position.y;
        }
        }
        
        }
      
    
    
    window.addEventListener('keydown', event =>{
      if(event.key == "Enter" && !started){
    started=true;
    username = document.getElementById('usernameInput').value;
    document.body.removeChild(document.getElementById('begin'));
    socket.emit('spawn player', username);
    animate();
    
    }
        if (event.key == "d"){
            movement.right = true;
        } else if (event.key == "a"){
            movement.left = true;
        } else if (event.key == "w"){
            movement.up = true;
        }
        
    })
    window.addEventListener('keyup', event=>{
        if (event.key == "d"){
            movement.right = false;
        } else if (event.key == "a"){
            movement.left = false;
        } else if (event.key == "w"){
            movement.up = false;
        }

    })
    



socket.on('move', function(user, valX, valY){
  
  if (players[user] == undefined){
    spawnPlayerManual(user);
    
  }
  players[user].position.x = valX;
  players[user].position.y = valY;

   // console.log(players[user]);
        
        

});
socket.on('disconnect', function(){
  socket.emit('update', username);
  
});
socket.on('update', function(msg){
  console.log(msg);
  
});
socket.on('spawn player', function(user) {
  if (!spawned){
    players[user] = new Player({x:100, y:400, color:"blue"});
    spawned = true;
  } else {
    players[user] = new Player({x:100, y:400, color:"red"});
  }
  usernameList.push(user);


});
function spawnPlayerManual(user) {
  console.log("created");
  players[user] = new Player({x:100, y:400, color:"red"});
  usernameList.push(user);
}


  </script>
  </body>
</html>
